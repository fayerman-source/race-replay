<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Replay: 800m Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0F172A; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; overflow-y: auto; }

        /* Layout Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px; /* Track takes space, Panel fixed width */
            gap: 1rem;
            min-height: 100vh; /* Allow growing */
            padding: 1rem;
        }

        /* Track Container */
        .track-wrapper {
            background-color: #1E293B;
            border-radius: 12px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            min-height: 620px; /* Ensure space for track */
        }

        .oval-track {
            position: relative;
            width: 350px;
            height: 600px;
            transform-origin: center;
        }

        /* SVG Styling */
        .track-surface {
            fill: #B91C1C;
            stroke: rgba(255,255,255,0.8);
            stroke-width: 2px;
        }
        .track-infield {
            fill: #1E293B; /* Match container bg for seamless look */
        }
        .start-finish-line {
            stroke: white;
            stroke-width: 4px;
        }
        .split-line {
            stroke: rgba(255,255,255,0.3);
            stroke-width: 2px;
            stroke-dasharray: 4 4;
        }

        /* Runner Dot */
        .runner-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
            z-index: 10;
            transition: transform 0.1s linear, box-shadow 0.2s;
        }

        /* Highlight Indicator */
        .focus-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid #FACC15; /* Yellow */
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s, top 0.1s linear, left 0.1s linear;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.6);
        }
        .focus-indicator.active {
            opacity: 1;
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .runner-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            text-shadow: 0 1px 2px black;
            background-color: rgba(0,0,0,0.6);
            padding: 1px 4px;
            border-radius: 4px;
            pointer-events: none;
        }

        /* Panel Styling */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            /* Allow panel to just flow naturally */
        }

        .card {
            background-color: #1E293B;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #334155;
        }

        /* Scrollbar for Start List */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Lap Dots */
        .lap-dots {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 4px;
        }
        .lap-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #334155;
            transition: background-color 0.3s;
        }
        .lap-dot.active {
            background-color: #3B82F6;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto; /* Track then Panel */
                height: auto;
                overflow-y: auto;
            }
            .track-wrapper { height: 500px; min-height: 500px; }
            .oval-track { transform: scale(0.75); }
        }
    </style>
</head>
<body>

    <div class="dashboard-grid">
        <!-- LEFT: Track Visualization -->
        <div class="track-wrapper">
            <div class="oval-track" id="ovalTrack">
                <!-- Vertical Track SVG -->
                <svg width="350" height="600" viewBox="0 0 350 600" class="absolute top-0 left-0">
                    <!-- Outer Lane Border -->
                    <path d="M 25 150 L 25 400 A 150 150 0 1 0 325 400 L 325 150 A 150 150 0 1 0 25 150" fill="#B91C1C" stroke="white" stroke-width="2"/>

                    <!-- Inner Infield -->
                    <path d="M 75 150 L 75 400 A 100 100 0 1 0 275 400 L 275 150 A 100 100 0 1 0 75 150" fill="#1E293B" stroke="white" stroke-width="2"/>

                    <!-- Finish Line (Right side, near top of straight) -->
                    <line x1="275" y1="200" x2="325" y2="200" class="start-finish-line" />
                    <text x="335" y="205" fill="white" font-size="10" font-weight="bold" text-anchor="start">FINISH</text>

                    <!-- 100m / Backstretch Mark -->
                    <line x1="25" y1="200" x2="75" y2="200" class="split-line" />
                    <text x="15" y="205" fill="rgba(255,255,255,0.5)" font-size="10" text-anchor="end">100m</text>

                    <!-- 150m Mark (Top Curve Apex) -->
                    <line x1="175" y1="25" x2="175" y2="75" class="split-line" />

                    <!-- 50m Mark (Bottom Curve Apex) -->
                    <line x1="175" y1="475" x2="175" y2="525" class="split-line" />

                </svg>

                <!-- Runners Layer -->
                <div id="runnersLayer" class="absolute top-0 left-0 w-full h-full">
                    <div id="focusIndicator" class="focus-indicator"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Dashboard Panel -->
        <div class="control-panel">

            <!-- 1. Header & Timer -->
            <div class="card text-center relative overflow-hidden shrink-0">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                <div class="flex justify-between items-center px-4 pt-4 pb-2">
                    <h1 class="text-lg font-bold text-gray-300">800m Championship Heat</h1>
                    <span class="text-[10px] bg-blue-900/50 px-2 py-0.5 rounded text-blue-300 border border-blue-800">200m Banked | 4 Laps</span>
                </div>
                <div class="text-5xl font-mono text-white tracking-widest mt-2" id="timer">0:00.00</div>
                <div class="text-xs text-gray-500 mb-2">Elapsed / <span class="text-gray-400">3:26.00</span></div>

                <!-- Lap Indicators -->
                <div class="flex flex-col items-center pb-2">
                    <div class="text-xs font-bold text-blue-400 uppercase tracking-wider" id="lapCounter">Lap 1 of 4</div>
                    <div class="lap-dots" id="lapDots">
                        <div class="lap-dot active"></div>
                        <div class="lap-dot"></div>
                        <div class="lap-dot"></div>
                        <div class="lap-dot"></div>
                    </div>
                </div>
            </div>

            <!-- 2. Race Recap (Commentary) -->
            <div class="card border-l-4 border-blue-500 bg-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs text-gray-400 uppercase font-bold">Race Recap</div>
                    <div class="text-xs text-green-400">‚óè REPLAY</div>
                </div>
                <div id="commentaryBox" class="text-lg font-medium text-white italic leading-snug min-h-[80px] flex items-center">
                    Runners at the line...
                </div>
            </div>

            <!-- 3. Controls -->
            <div class="card">
                <div class="flex gap-2 justify-center mb-4">
                    <button onclick="toggleRace()" id="btnStart" class="bg-green-600 hover:bg-green-700 text-white w-full py-3 rounded font-bold transition flex items-center justify-center gap-2">
                        <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        <span id="btnText">START</span>
                    </button>
                    <button onclick="resetRace()" class="bg-gray-600 hover:bg-gray-700 text-white w-1/3 py-3 rounded font-bold transition">
                        Reset
                    </button>
                </div>
            </div>

            <!-- 4. Stats / Legend -->
            <div class="card">
                <h3 class="text-xs text-gray-400 uppercase font-bold mb-3">Live Splits</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center p-2 bg-gray-700/50 rounded border-l-2 border-blue-500">
                        <span class="text-gray-300">Leader (Melodi #2)</span>
                        <span class="font-mono font-bold text-blue-400">2:21.58</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-700/50 rounded border-l-2 border-orange-500">
                        <span class="text-gray-300">Skye (Rank 8 / #10)</span>
                        <span class="font-mono font-bold text-orange-400">3:04.27</span>
                    </div>
                    <div class="grid grid-cols-4 gap-1 mt-2 text-center text-xs text-gray-500">
                        <div>0-200<br><span class="text-white">41.5</span></div>
                        <div>200-400<br><span class="text-white">47.0</span></div>
                        <div>400-600<br><span class="text-white">48.3</span></div>
                        <div>600-800<br><span class="text-white">47.4</span></div>
                    </div>
                </div>
            </div>

            <!-- 5. Start List -->
            <div class="card flex-grow">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs text-gray-400 uppercase font-bold">Start List</h3>
                    <span class="text-[10px] text-gray-500"># = Hip/Bib</span>
                </div>
                <div class="space-y-2 text-xs overflow-y-auto max-h-40 pr-2 custom-scrollbar" id="startListContainer">
                    <!-- Populated by JS -->
                </div>
            </div>

        </div>
    </div>

<script>
    // Runner Data: Anonymized demo data (first names only)
    const runners = [
        { id: 1, name: "MA", fullName: "Melodi", team: "Team Blue", age: 13, bib: 2, color: "#3B82F6", splits: [0, 32.94, 68.67, 105.05, 141.58] }, // 1st
        { id: 2, name: "PD", fullName: "Parvati", team: "Team Red", age: 13, bib: 3, color: "#60A5FA", splits: [0, 33.86, 70.82, 108.62, 146.73] }, // 2nd
        { id: 3, name: "RM", fullName: "Reid", team: "Team Green", age: 13, bib: 5, color: "#93C5FD", splits: [0, 33.63, 71.49, 111.25, 149.88] }, // 3rd
        { id: 4, name: "EH", fullName: "Ephie", team: "Team Blue", age: 14, bib: 4, color: "#93C5FD", splits: [0, 34.52, 72.14, 110.78, 150.00] }, // 4th
        { id: 5, name: "UD", fullName: "Uma", team: "Team Red", age: 13, bib: 6, color: "#6B7280", splits: [0, 35.31, 76.86, 122.48, 168.78] }, // 5th
        { id: 6, name: "DW", fullName: "Demi", team: "Team Yellow", age: 13, bib: 8, color: "#6B7280", splits: [0, 38.74, 85.49, 135.17, 174.25] }, // 6th
        { id: 7, name: "JR", fullName: "Jahzara", team: "Team Purple", age: 11, bib: 7, color: "#6B7280", splits: [0, 34.85, 76.55, 125.96, 178.73] }, // 7th
        { id: 8, name: "SF", fullName: "Skye", team: "Flyers TC", age: 10, bib: 10, color: "#F97316", splits: [0, 41.53, 88.55, 136.83, 184.27], highlight: true }, // SKYE
        { id: 9, name: "MS", fullName: "Margeaux", team: "Team Orange", age: 10, bib: 9, color: "#9CA3AF", splits: [0, 42.87, 91.37, 144.00, 190.71] }, // 9th
        { id: 10, name: "CH", fullName: "Cato", team: "Team Green", age: 10, bib: 11, color: "#9CA3AF", splits: [0, 42.25, 91.72, 144.35, 192.25] }, // 10th
        { id: 11, name: "EM", fullName: "Emma", team: "Team Orange", age: 10, bib: 12, color: "#4B5563", splits: [0, 41.91, 92.76, 148.49, 206.00] }  // 11th
    ];

    // Commentary timing with text and audio paths (anonymized - first names only)
    const commentaryTiming = [
        // PRE-RACE INTRO (5 seconds)
        [-5,  "commentary_anonymized/commentary_00_-5s.mp3",  18.0,  null,  "Welcome to the 800 meter championship heat. Eleven runners on the line, ages 10 to 14. Watch for Melodi, bib 2, the top seed. And Skye, bib 10, just 10 years old racing against older athletes."],
        
        // RACE ACTION (anonymized audio - first names only)
        [0,   "commentary_anonymized/commentary_01_0s.mp3",   5.5,  null,  "Runners set. Clean start. Melodi immediately establishing position on the rail."],
        [8,   "commentary_anonymized/commentary_02_8s.mp3",   10.0,  null,  "Melodi out fast through the first hundred. Committing to a front-running strategy."],
        [18,  "commentary_anonymized/commentary_03_18s.mp3",  7.3,   null,  "Field stringing out. Separation between front pack and chase group. This is where tactical decisions matter."],
        [32,  "commentary_anonymized/commentary_04_32s.mp3",  7.9,   1,     "Thirty-two nine for Melodi at the two hundred. Aggressive pacing. The question is whether she can hold this through the middle."],
        [41,  "commentary_anonymized/commentary_05_41s.mp3",  9.7,   8,     "Now Skye coming through the first two hundred. Forty-one flat. Smart controlled start. Eight seconds back, not pulled out by the fast early pace."],
        [52,  "commentary_anonymized/commentary_06_52s.mp3",  11.3,  2,     "Middle pack feeling the gap. Parvati and Reid trying to hold contact with Melodi but she's pulling away. Decision point: go with the leader or run your own race."],
        [60,  "commentary_anonymized/commentary_07_60s.mp3",  6.9,   1,     "Four hundred meters. Melodi still commanding at one oh eight. The chase pack about five meters back."],
        [68,  "commentary_anonymized/commentary_08_68s.mp3",  12.9,  1,     "One oh eight at the bell for Melodi. That was a thirty-five second lap. She's slowing. How much does she have left?"],
        [75,  "commentary_anonymized/commentary_09_75s.mp3",  9.5,   8,     "Here's where it gets interesting. Skye just split one twenty-eight for the first four hundred. Negative split pacing. While others fade, she's maintaining."],
        [88,  "commentary_anonymized/commentary_10_88s.mp3",  9.5,   8,     "Look at the separation. The field is completely strung out. Skye sitting in eighth, twenty meters off the lead but perfect position to move up."],
        [98,  "commentary_anonymized/commentary_11_98s.mp3",  10.0,  null,  "Six hundred meter mark. This is where the race is decided. Melodi's lead shrinking but she's still out front."],
        [105, "commentary_anonymized/commentary_12_105s.mp3", 11.0,  1,     "One forty-five for Melodi through six hundred. She's paying for that early pace but still fighting. Can she hold on?"],
        [115, "commentary_anonymized/commentary_13_115s.mp3", 10.0,  8,     "Skye through six hundred in two sixteen. She's running people down. Closing on the field while others are tying up."],
        [122, "commentary_anonymized/commentary_14_122s.mp3", 10.0,  1,     "One hundred meters to go for Melodi. She's going to win this but watch the clock. Can she break two twenty-two?"],
        [130, "commentary_anonymized/commentary_15_130s.mp3", 8.2,   8,     "Skye flying now. Passing people. All that patience early is paying off. Moved up to eighth and still closing."],
        [141, "commentary_anonymized/commentary_16_141s.mp3", 7.5,   1,     "Two twenty-one fifty-eight for Melodi. Outstanding performance. She held on after going out hard."],
        [148, "commentary_anonymized/commentary_17_148s.mp3", 12.5,  8,     "But watch Skye coming home. Still moving. Forty-seven second final lap after a controlled start. That's how you negative split an eight hundred."],
        [165, "commentary_anonymized/commentary_18_165s.mp3", 9.0,   8,     "Fifty meters to go for Skye. She's gutting it out. Holding her pace while the early leaders are done."],
        [184, "commentary_anonymized/commentary_19_184s.mp3", 12.0,  8,     "Three oh four twenty-seven. Massive personal record for Skye. Twenty second improvement. That negative split strategy executed perfectly."],
        [191, "commentary_anonymized/commentary_20_191s.mp3", 8.0,   9,     "Margeaux crosses in three ten. Strong finish from the chase pack."],
        [198, "commentary_anonymized/commentary_21_198s.mp3", 10.0,  null,  "What a race. From Melodi's dominant front-running to Skye's brilliant negative split. Two different strategies, both executed beautifully."]
    ];

    // Build audio lookup
    const audioElements = {};
    let isAudioPlaying = false; // Track if any audio is currently playing
    
    commentaryTiming.forEach(([time, filename, duration, subjectId, text], index) => {
        const audio = new Audio(filename);
        audio.preload = "auto";
        // Mark not playing when this audio ends
        audio.onended = () => {
            isAudioPlaying = false;
        };
        audioElements[index] = audio;
    });

    // Find next commentary that should play (event-based, no overlap)
    function getNextCommentaryIndex() {
        // If audio is currently playing, don't start new one
        if (isAudioPlaying) {
            return -1;
        }

        // Find the next commentary based on trigger time
        for (let i = 0; i < commentaryTiming.length; i++) {
            const [triggerTime] = commentaryTiming[i];
            if (triggerTime <= raceTime && i > lastPlayedCommentary) {
                return i;
            }
        }
        return -1;
    }

    // Vertical Track Geometry Logic
    const LAP_PIXELS = 1285.4;
    const PIXELS_PER_METER = LAP_PIXELS / 200;

    function getTrackCoordinates(meters) {
        let d = (meters % 200) * PIXELS_PER_METER;
        if (d < 50) return { x: 300, y: 200 - d }; // Right Straight 1
        d -= 50;
        const curveLen = Math.PI * 125;
        if (d < curveLen) { // Top Curve
            const angle = 0 - (d / curveLen) * Math.PI;
            return { x: 175 + 125 * Math.cos(angle), y: 150 + 125 * Math.sin(angle) };
        }
        d -= curveLen;
        if (d < 250) return { x: 50, y: 150 + d }; // Left Straight
        d -= 250;
        if (d < curveLen) { // Bottom Curve
            const angle = Math.PI - (d / curveLen) * Math.PI;
            return { x: 175 + 125 * Math.cos(angle), y: 400 + 125 * Math.sin(angle) };
        }
        d -= curveLen;
        return { x: 300, y: 400 - d }; // Right Straight 2
    }

    // Initialize DOM
    const runnersLayer = document.getElementById('runnersLayer');
    const startListContainer = document.getElementById('startListContainer');
    const focusIndicator = document.getElementById('focusIndicator');

    runners.forEach((r, index) => {
        // Track Dots
        const dot = document.createElement('div');
        dot.className = "runner-dot";
        dot.style.backgroundColor = r.color;

        const laneOffset = (index % 3) * 8 - 4;
        dot.dataset.offset = laneOffset;

        if(r.highlight) {
            dot.style.border = "3px solid white";
            dot.style.zIndex = "50";
            dot.style.transform = "translate(-50%, -50%) scale(1.3)";
        }
        dot.id = `runner-${r.id}`;
        // Use BIB number for the dot text
        dot.innerText = r.bib;

        if (r.highlight) {
            const label = document.createElement('div');
            label.className = "runner-label";
            label.innerText = "Skye";
            dot.appendChild(label);
        }
        runnersLayer.appendChild(dot);

        // Start List Entry
        const entry = document.createElement('div');
        entry.className = `flex items-center gap-2 p-1.5 rounded hover:bg-gray-700/50 transition ${r.highlight ? 'bg-orange-500/20' : ''}`;
        entry.innerHTML = `
            <div class="w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center text-[9px] font-bold text-white" style="background-color: ${r.color}">
                ${r.bib}
            </div>
            <div class="flex-grow min-w-0">
                <div class="font-bold truncate text-white ${r.highlight ? 'text-orange-400' : ''}">${r.fullName}</div>
                <div class="text-gray-400 truncate text-[10px]">${r.team} | Age ${r.age}</div>
            </div>
            <div class="text-right text-gray-500 font-mono text-[10px]">
                ${r.splits[4] ? formatTime(r.splits[4]) : '--:--'}
            </div>
        `;
        startListContainer.appendChild(entry);
    });

    function getDistanceAtTime(splits, currentTime) {
        if (currentTime <= 0) return 0;
        if (currentTime >= splits[splits.length-1]) return 800;
        for (let i = 0; i < splits.length - 1; i++) {
            if (currentTime >= splits[i] && currentTime < splits[i+1]) {
                const segmentTime = splits[i+1] - splits[i];
                const timeInSegment = currentTime - splits[i];
                return (i * 200) + (timeInSegment / segmentTime * 200);
            }
        }
        return 800;
    }

    function updatePositions() {
        if (!isRunning) return;

        raceTime += (1/60) * speed;
        document.getElementById('timer').innerText = formatTime(raceTime);

        // Show countdown during pre-race intro
        if (raceTime < 0) {
            const secondsToStart = Math.ceil(Math.abs(raceTime));
            document.getElementById('lapCounter').innerText = `Race starts in ${secondsToStart}...`;
        } else {
            const skyeDist = getDistanceAtTime(runners[7].splits, raceTime);
            const currentLap = Math.min(4, Math.floor(skyeDist / 200) + 1);
            document.getElementById('lapCounter').innerText = `Lap ${currentLap} of 4`;
        }

        // Update Lap Dots
        const lapDots = document.querySelectorAll('.lap-dot');
        lapDots.forEach((dot, idx) => {
            if (idx < currentLap) dot.classList.add('active');
            else dot.classList.remove('active');
        });

        // Update Commentary & Indicator (Event-based, no overlap)
        const nextCommentaryIndex = getNextCommentaryIndex();
        if (nextCommentaryIndex !== -1) {
            const [triggerTime, filename, duration, subjectId, commentaryText] = commentaryTiming[nextCommentaryIndex];
            
            // Update text display
            const box = document.getElementById('commentaryBox');
            if (box.innerText !== commentaryText) {
                box.innerText = commentaryText;
                box.parentElement.classList.add("ring-2", "ring-blue-500");
                setTimeout(() => box.parentElement.classList.remove("ring-2", "ring-blue-500"), 300);
            }
            
            // Play audio if available
            if (audioElements[nextCommentaryIndex]) {
                isAudioPlaying = true;
                audioElements[nextCommentaryIndex].currentTime = 0;
                audioElements[nextCommentaryIndex].play().catch(e => {
                    console.log("Audio play failed:", e);
                    isAudioPlaying = false;
                });
                lastPlayedCommentary = nextCommentaryIndex;
                
                // Sync Indicator
                if (subjectId) {
                    const targetRunner = document.getElementById(`runner-${subjectId}`);
                    if (targetRunner) {
                        focusIndicator.style.top = targetRunner.style.top;
                        focusIndicator.style.left = targetRunner.style.left;
                        focusIndicator.classList.add('active');
                    }
                } else {
                    focusIndicator.classList.remove('active');
                }
            }
        }

        let finishedCount = 0;
        runners.forEach(r => {
            // Keep runners at start during pre-race intro (time < 0)
            const effectiveTime = raceTime < 0 ? 0 : raceTime;
            const dist = getDistanceAtTime(r.splits, effectiveTime);
            const coords = getTrackCoordinates(dist);
            const dot = document.getElementById(`runner-${r.id}`);
            const offset = parseFloat(dot.dataset.offset);

            dot.style.left = `${coords.x + offset}px`;
            dot.style.top = `${coords.y}px`;

            if (dist >= 800) {
                dot.style.opacity = "0.3";
                finishedCount++;
            }
        });

        if (finishedCount === runners.length) {
            stopRace();
        } else {
            requestAnimationFrame(updatePositions);
        }
    }

    function formatTime(seconds) {
        if (seconds < 0) {
            const absSeconds = Math.abs(seconds);
            const s = Math.floor(absSeconds);
            const ms = Math.floor((absSeconds % 1) * 100);
            return `-${s}.${ms < 10 ? '0' : ''}${ms}`;
        }
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        const ms = Math.floor((seconds % 1) * 100);
        return `${m}:${s < 10 ? '0' : ''}${s}.${ms < 10 ? '0' : ''}${ms}`;
    }

    function toggleRace() {
        if (isRunning) {
            pauseRace();
        } else {
            startRace();
        }
    }

    function startRace() {
        if (isRunning) return;
        isRunning = true;
        
        // Start at -5s (pre-race intro) if at beginning
        if (raceTime === 0) {
            raceTime = -5;
        }
        
        // Update button to show PAUSE state
        document.getElementById('playIcon').classList.add('hidden');
        document.getElementById('pauseIcon').classList.remove('hidden');
        document.getElementById('btnText').innerText = "PAUSE";
        document.getElementById('btnStart').classList.remove('bg-green-600', 'hover:bg-green-700');
        document.getElementById('btnStart').classList.add('bg-yellow-600', 'hover:bg-yellow-700');
        
        requestAnimationFrame(updatePositions);
    }

    function pauseRace() {
        isRunning = false;
        
        // Update button to show START/RESUME state
        document.getElementById('playIcon').classList.remove('hidden');
        document.getElementById('pauseIcon').classList.add('hidden');
        // Show START if in intro, RESUME if race has started
        document.getElementById('btnText').innerText = raceTime >= 0 ? "RESUME" : "START";
        document.getElementById('btnStart').classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        document.getElementById('btnStart').classList.add('bg-green-600', 'hover:bg-green-700');
        
        // Pause any currently playing audio
        Object.values(audioElements).forEach(audio => {
            if (!audio.paused) {
                audio.pause();
            }
        });
        isAudioPlaying = false;
    }

    function stopRace() {
        isRunning = false;
        document.getElementById('btnText').innerText = "FINISHED";
        document.getElementById('playIcon').classList.remove('hidden');
        document.getElementById('pauseIcon').classList.add('hidden');
        document.getElementById('btnStart').classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
        document.getElementById('btnStart').classList.add('bg-gray-600');
        focusIndicator.classList.remove('active');
    }

    function resetRace() {
        isRunning = false;
        raceTime = 0;
        lastPlayedCommentary = -1;
        isAudioPlaying = false;
        isAudioPlaying = false;

        // Stop all audio and reset
        Object.values(audioElements).forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
        });
        
        // Reset UI
        document.getElementById('timer').innerText = "0:00.00";
        document.getElementById('lapCounter').innerText = "Lap 1 of 4";
        document.getElementById('commentaryBox').innerText = "Runners at the line...";
        focusIndicator.classList.remove('active');
        
        // Reset button to START state
        document.getElementById('playIcon').classList.remove('hidden');
        document.getElementById('pauseIcon').classList.add('hidden');
        document.getElementById('btnText').innerText = "START";
        document.getElementById('btnStart').classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-gray-600');
        document.getElementById('btnStart').classList.add('bg-green-600', 'hover:bg-green-700');

        // Reset dots
        const lapDots = document.querySelectorAll('.lap-dot');
        lapDots.forEach((dot, idx) => {
            if(idx === 0) dot.classList.add('active');
            else dot.classList.remove('active');
        });

        runners.forEach(r => {
            const coords = getTrackCoordinates(0);
            const dot = document.getElementById(`runner-${r.id}`);
            const offset = parseFloat(dot.dataset.offset);
            dot.style.left = `${coords.x + offset}px`;
            dot.style.top = `${coords.y}px`;
            dot.style.opacity = "1";
        });
    }

    resetRace();
</script>

</body>
</html>
